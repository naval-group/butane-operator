name: Release

on:
  push:
    tags:
      - 'v*'

# Top-level permissions are restricted; each job specifies only what it needs
permissions:
  contents: read

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating GitHub releases and uploading assets
      packages: write  # Required for pushing to GHCR
      id-token: write  # Required for cosign keyless signing
    outputs:
      digest: ${{ steps.image.outputs.digest }}

    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
      with:
        go-version-file: 'go.mod'
        check-latest: true

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: Build and push Docker image
      id: image
      uses: docker/build-push-action@5176d81f87c23d6fc96624dfdbcd9f3830bbe445 # v6.5.0
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Install cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
      with:
        cosign-release: 'v2.2.4'

    - name: Sign container image
      run: |
        cosign sign --yes ghcr.io/${{ github.repository }}@${{ steps.image.outputs.digest }}

    - name: Run tests
      run: make test

    - name: Build release artifacts
      run: |
        make build-installer IMG=ghcr.io/${{ github.repository }}:${{ github.ref_name }}

    - name: Verify install.yaml was generated
      run: |
        if [ ! -f dist/install.yaml ]; then
          echo "Error: dist/install.yaml was not generated"
          exit 1
        fi
        echo "✓ install.yaml generated successfully"
        echo "Verifying image reference in install.yaml..."
        if grep -q "ghcr.io/${{ github.repository }}:${{ github.ref_name }}" dist/install.yaml; then
          echo "✓ Correct image reference found: ghcr.io/${{ github.repository }}:${{ github.ref_name }}"
        else
          echo "Error: Correct image reference not found in install.yaml"
          exit 1
        fi

    - name: Generate SBOM
      uses: anchore/sbom-action@d94f46e13c6c62f59525ac9a1e147a99dc0b9bf5 # v0.17.0
      with:
        image: ghcr.io/${{ github.repository }}@${{ steps.image.outputs.digest }}
        output-file: sbom.spdx.json
        format: spdx-json

    - name: Create GitHub Release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: |
          dist/install.yaml
          sbom.spdx.json
        body: |
          ## Installation

          Install the Butane Operator using kubectl:

          ```bash
          kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/install.yaml
          ```

          This will install:
          - Custom Resource Definitions (CRDs)
          - RBAC roles and bindings
          - Operator deployment in the `butane-operator-system` namespace

          ## Container Images

          **Multi-architecture support:** `linux/amd64`, `linux/arm64`

          ```bash
          # Version tag
          ghcr.io/${{ github.repository }}:${{ github.ref_name }}

          # Immutable digest (recommended for production)
          ghcr.io/${{ github.repository }}@${{ steps.image.outputs.digest }}
          ```

          ## Security

          ### Image Verification

          The container image is signed with [Sigstore cosign](https://docs.sigstore.dev/cosign/overview/). Verify the signature:

          ```bash
          cosign verify ghcr.io/${{ github.repository }}@${{ steps.image.outputs.digest }} \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com"
          ```

          ### SBOM (Software Bill of Materials)

          Download the SBOM from release assets: `sbom.spdx.json`

          ### SLSA Provenance

          SLSA Level 3 provenance is generated and attached to this release automatically.

          ## Quick Start

          After installation, create a ButaneConfig resource:

          ```yaml
          apiVersion: butane.operators.naval-group.com/v1alpha1
          kind: ButaneConfig
          metadata:
            name: example
            namespace: default
          spec:
            config:
              variant: fcos
              version: 1.5.0
              storage:
                files:
                  - path: /etc/motd
                    contents:
                      inline: |
                        Hello from Butane Operator!
          ```

          Apply it and check the generated secret:

          ```bash
          kubectl apply -f example.yaml
          kubectl get secret example-ignition -o yaml
          ```

          ## Examples

          See the [examples directory](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/examples) for more use cases.

          ## Documentation

          - [README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)
          - [Contributing Guide](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CONTRIBUTING.md)
          - [Security Policy](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/SECURITY.md)
        generate_release_notes: true

  provenance:
    name: Generate Provenance
    needs: [release]
    permissions:
      actions: read     # Required for reading workflow artifacts
      id-token: write   # Required for SLSA provenance signing
      contents: write   # Required for attaching provenance to release
      packages: write   # Required for attaching provenance to container image
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ghcr.io/${{ github.repository }}
      digest: ${{ needs.release.outputs.digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}